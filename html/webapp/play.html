<!doctype html>
<html>
<head>
    <title>Cubes</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1"/>
    <link href="styles.css" rel="stylesheet" type="text/css">
    <script src="soundmanager2-setup.js"></script>
    <script src="soundmanager2-jsmin.js"></script>

    <style>
        body {
            margin: 0;
        }

        textarea {
            display: none;
        }

        canvas {
            position: absolute;
            display: block;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
    </style>
</head>

<body>
<div align="center" id="embed-html" oncontextmenu="return false;"></div>
<script src="https://unpkg.com/dexie@^2.0.0-beta/dist/dexie.js"></script>
<script type="text/javascript" src="html/html.nocache.js"></script>
</body>
<script>
    function handleMouseDown(evt) {
        if (window.cubesWantsCursorCatched && !window.cubesCursorCatched) {
            try {
                var canvas = window.document.getElementsByTagName('canvas')[0];
                canvas.requestPointerLock = canvas.requestPointerLock || canvas.mozRequestPointerLock || canvas.webkitRequestPointerLock;
                if (canvas.requestPointerLock) {
                    canvas.requestPointerLock();
                }
            } catch (e) {
                console.log("requestPointerLock", e);
            }
        }
        evt.preventDefault();
        evt.stopPropagation();
        evt.target.style.cursor = 'default';
    }

    function handleMouseUp(evt) {
        evt.preventDefault();
        evt.stopPropagation();
        evt.target.style.cursor = '';
    }

    document.getElementById('embed-html').addEventListener('mousedown', handleMouseDown, false);
    document.getElementById('embed-html').addEventListener('mouseup', handleMouseUp, false);
    document.addEventListener('contextmenu', function (event) {
        event.preventDefault();
    });

    document.querySelector('body').onkeydown = function(e) {
        if ((e.keyCode > 47 && e.keyCode < 58)) return; // number keys
        if (e.keyCode === 32 || e.keyCode === 13) return; // spacebar & return key(s) (if you want to allow carriage returns)
        if (e.keyCode > 64 && e.keyCode < 91) return; // letter keys
        if (e.keyCode > 95 && e.keyCode < 112) return; // numpad keys
        if (e.keyCode > 185 && e.keyCode < 193) return; // ;=,-./` (in order)
        if (e.keyCode > 218 && e.keyCode < 223) return; // [\]' (in order)
        if (e.keyCode === 122) return; // F11
        e.preventDefault();
    };

    // pointer lock
    function moveCallback(e) {
        window.cubesMovementX = e.movementX || e.mozMovementX || e.webkitMovementX || 0;
        window.cubesMovementY = e.movementY || e.mozMovementY || e.webkitMovementY || 0;
    }

    function changeCallback() {
        var canvas = document.getElementsByTagName("canvas")[0];
        if (document.pointerLockElement === canvas || document.mozPointerLockElement === canvas || document.webkitPointerLockElement === canvas) {
            document.addEventListener("mousemove", moveCallback, false);
            window.cubesCursorCatched = true;
        } else {
            document.removeEventListener("mousemove", moveCallback, false);
            window.cubesCursorCatched = false;
            window.cubesMovementX = 0;
            window.cubesMovementY = 0;
            window.cubesEsc = window.cubesWantsCursorCatched;
        }
    }

    document.addEventListener('pointerlockchange', changeCallback, false);
    document.addEventListener('mozpointerlockchange', changeCallback, false);
    document.addEventListener('webkitpointerlockchange', changeCallback, false);

    // indexedDB
    window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
    window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction || {READ_WRITE: "readwrite"};
    window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
</script>
</html>
